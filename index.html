<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synapse Co-Pilot — Bridging the Gap in Education</title>

  <!-- Tailwind config before CDN -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = { theme: { extend: { colors: { brandBlue:'#1e40af', brandGold:'#d4af37' }}}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (production) + ReactDOM + Babel (order matters) -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDKs (compat) -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <!-- Icons (optional; won’t cause blank if missing) -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" sizes="16x16" href="/favicon-16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#1e40af">

  <style> body{background:#0b1220;color:#fff} </style>
</head>
<body>
  <div id="root"></div>

  <!-- App (Google Sign-In only; no anonymous) + on-screen error/debug -->
  <script type="text/babel" data-presets="env,react">
    // ------------ Visible boot + error overlay (helps on phones) ------------
    const rootEl = document.getElementById('root');
    rootEl.innerHTML = `
      <div style="padding:16px;text-align:center;color:#fff;background:#0b1220">
        <div style="font-weight:700;margin-bottom:6px">Booting Synapse…</div>
        <div id="synapse-status" style="opacity:.8;font-size:12px">Loading scripts…</div>
      </div>
    `;
    function showErr(msg){
      const s = document.getElementById('synapse-status');
      if (s) s.textContent = 'Error: ' + msg;
      console.error('[Synapse]', msg);
    }
    window.addEventListener('error', e => showErr(e.error?.message || e.message));
    window.addEventListener('unhandledrejection', e => showErr(e.reason?.message || String(e.reason)));

    // ------------ Wait for libs (React/ReactDOM/firebase/Babel) ------------
    const REQUIRED = ['React','ReactDOM','firebase','Babel'];
    const haveLibs = () => REQUIRED.every(k => !!window[k]);

    document.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('synapse-status');
      if (s) s.textContent = 'Waiting for libs…';
      let tries = 50; // ~7.5s
      (function wait(){
        if (haveLibs()) return boot();
        if (--tries <= 0) return showErr('Required scripts did not load (React/Firebase/Babel).');
        setTimeout(wait, 150);
      })();
    });

    async function boot(){
      try{
        const s = document.getElementById('synapse-status');
        if (s) s.textContent = 'Initializing…';

        // --- Firebase config (your project) ---
        const FB_CONFIG = {
          apiKey: "AIzaSyBT95w8fzJr9J5WCYe8iwFkvSrwXds5sms",
          authDomain: "trackopmn.firebaseapp.com",
          projectId: "trackopmn",
          storageBucket: "trackopmn.appspot.com",
          appId: "1:325895934431:web:50665d95aab0ac1a4b746a",
          messagingSenderId: "325895934431",
          measurementId: "G-QX53NY1CJC"
        };

        // Init Firebase safely
        try { firebase.apps.length ? firebase.app() : firebase.initializeApp(FB_CONFIG); } catch {}

        const auth = firebase.auth();

        // --------- Netlify Functions endpoints ----------
        const GEMINI_PROXY_URL = "/.netlify/functions/synapseGemini";
        const SEARCH_PROXY_URL = "/.netlify/functions/searchStandard";
        const GROUPS_PROXY_URL = "/.netlify/functions/groupIntelligence";

        // --------- Helpers (require Google-signed-in user) ----------
        async function idToken() {
          const u = auth.currentUser;
          if (!u) throw new Error("Not signed in");
          return await u.getIdToken();
        }
        async function callGemini(payload){
          const token = await idToken();
          const res = await fetch(GEMINI_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
            body: JSON.stringify(payload)
          });
          const txt = await res.text();
          if(!res.ok) throw new Error(txt || `Gemini ${res.status}`);
          return JSON.parse(txt);
        }
        async function callSearch({subject,grade}){
          const token = await idToken();
          const res = await fetch(SEARCH_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
            body: JSON.stringify({subject,grade})
          });
          const txt = await res.text();
          if(!res.ok) throw new Error(txt || `Search ${res.status}`);
          return JSON.parse(txt);
        }
        async function callGroups({roster,standard,goal='homogeneous'}){
          const token = await idToken();
          const res = await fetch(GROUPS_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
            body: JSON.stringify({roster,standard,goal})
          });
          const txt = await res.text();
          if(!res.ok) throw new Error(txt || `Groups ${res.status}`);
          return JSON.parse(txt);
        }

        // --------- UI: Sign-in screen + App (only after Google auth) ----------
        function SignIn() {
          async function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
              await auth.signInWithPopup(provider).catch(async (e) => {
                if (e.code === 'auth/popup-blocked' || e.code === 'auth/operation-not-supported-in-this-environment') {
                  await auth.signInWithRedirect(provider);
                } else { throw e; }
              });
            } catch (err) { showErr('Sign-in failed: ' + (err.message || err)); }
          }
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="w-full max-w-sm bg-white/5 border border-white/10 rounded-xl p-6 text-center">
                <h1 className="text-xl font-bold mb-2">Synapse Co-Pilot</h1>
                <p className="text-sm opacity-80 mb-4">Sign in with your Google account to continue.</p>
                <button onClick={signIn} className="w-full min-h-[44px] bg-white text-black rounded px-3 py-2">
                  Continue with Google
                </button>
              </div>
            </div>
          );
        }

        function TopBar({user}) {
          async function signOut(){ await auth.signOut(); }
          return (
            <header className="border-b border-white/10">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
                <img src="/logo.svg" onError={(e)=>e.target.style.display='none'} alt="" className="w-6 h-6" />
                <div className="mr-auto font-semibold">Synapse Co-Pilot</div>
                <div className="text-sm opacity-80 hidden sm:block">{user?.email}</div>
                <button onClick={signOut} className="min-h-[36px] px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded">
                  Sign out
                </button>
              </div>
            </header>
          );
        }

        function App() {
          const [subject,setSubject] = React.useState('Civics');
          const [grade,setGrade]     = React.useState('7');
          const [standards,setStandards] = React.useState([]);
          const [msg,setMsg] = React.useState('Ready');

          async function fetchStandards(){
            try{
              setMsg('Fetching standards…');
              const res = await callSearch({subject,grade});
              setStandards(res.standards || []);
              setMsg('Loaded ✓');
            }catch(e){ setMsg('Error: '+e.message); }
          }

          return (
            <div>
              <TopBar user={firebase.auth().currentUser} />
              <main className="max-w-3xl mx-auto p-6">
                <p className="text-sm opacity-80 mb-4">{msg}</p>
                <div className="grid gap-3 sm:grid-cols-3 mb-4">
                  <label className="block">
                    <span className="text-xs opacity-80">Subject</span>
                    <input className="mt-1 w-full bg-white/5 border border-white/10 rounded px-2 py-2"
                           value={subject} onChange={e=>setSubject(e.target.value)} />
                  </label>
                  <label className="block">
                    <span className="text-xs opacity-80">Grade</span>
                    <input className="mt-1 w-full bg-white/5 border border-white/10 rounded px-2 py-2"
                           value={grade} onChange={e=>setGrade(e.target.value)} />
                  </label>
                  <div className="flex items-end">
                    <button className="w-full min-h-[44px] bg-white text-black rounded px-3 py-2"
                            onClick={fetchStandards}>Fetch Standards</button>
                  </div>
                </div>

                <ul className="text-sm space-y-1">
                  {standards.length === 0 && <li className="opacity-70">No standards loaded yet.</li>}
                  {standards.map(s => <li key={s.code}><span className="font-semibold">{s.code}</span> — {s.title}</li>)}
                </ul>
              </main>
            </div>
          );
        }

        function Root() {
          const [user,setUser] = React.useState(() => firebase.auth().currentUser);
          React.useEffect(() => firebase.auth().onAuthStateChanged(setUser), []);
          return user ? <App/> : <SignIn/>;
        }

        ReactDOM.createRoot(rootEl).render(<Root/>);
        const s2 = document.getElementById('synapse-status'); if (s2) s2.textContent = 'Rendering…';

      }catch(e){ showErr(e.message || String(e)); }
    }
  </script>
</body>
</html>
