<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synapse Co-Pilot — Bridging the Gap in Education</title>

  <!-- Tailwind config before CDN -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          colors: { brandBlue: '#1e40af', brandGold: '#d4af37' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (production) + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Favicons / icons (optional but recommended) -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" sizes="16x16" href="/favicon-16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#1e40af">

  <style>
    body { background:#0b1220; color:#fff; }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- Ultra-fast black-screen fix + full boot -->
  <script type="text/babel" data-presets="env,react">
    // Show immediate boot banner so we never look blank
    const rootEl = document.getElementById('root');
    rootEl.innerHTML = `
      <div style="padding:16px;text-align:center;color:#fff;background:#0b1220">
        <div style="font-weight:700;margin-bottom:6px">Booting Synapse…</div>
        <div id="synapse-status" style="opacity:.8;font-size:12px">Loading scripts…</div>
      </div>
    `;

    // Minimal error overlay
    window.addEventListener('error', e => showErr(e.error?.message || e.message));
    window.addEventListener('unhandledrejection', e => showErr(e.reason?.message || String(e.reason)));
    function showErr(msg){
      const el = document.getElementById('synapse-status');
      if (el) el.textContent = 'Error: ' + msg;
      console.error('[Synapse]', msg);
    }

    // Wait for required globals
    const REQUIRED = ['React','ReactDOM','firebase'];
    const haveLibs = () => REQUIRED.every(k => window[k]);

    document.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('synapse-status');
      if (s) s.textContent = 'Waiting for libs…';
      let tries = 40;             // ~6s total
      (function wait(){
        if (haveLibs()) return boot();
        if (--tries <= 0) return showErr('Required scripts did not load (React/Firebase/Babel).');
        setTimeout(wait, 150);
      })();
    });

    async function boot(){
      try{
        const s = document.getElementById('synapse-status');
        if (s) s.textContent = 'Initializing…';

        // --- Firebase config (keep as provided) ---
        const FB_CONFIG = {
          apiKey: "AIzaSyBT95w8fzJr9J5WCYe8iwFkvSrwXds5sms",
          authDomain: "trackopmn.firebaseapp.com",
          projectId: "trackopmn",
          storageBucket: "trackopmn.appspot.com",
          appId: "1:325895934431:web:50665d95aab0ac1a4b746a",
          messagingSenderId: "325895934431",
          measurementId: "G-QX53NY1CJC"
        };

        // Init Firebase safely
        try { firebase.apps.length ? firebase.app() : firebase.initializeApp(FB_CONFIG); } catch {}

        const auth = firebase.auth();
        auth.onAuthStateChanged(u => {
          if (!u) auth.signInAnonymously().catch(e => showErr('Auth: ' + e.message));
        });

        // Give auth a moment so ID token exists before first calls
        await new Promise(r => setTimeout(r, 400));

        // --- Netlify Function endpoints ---
        const GEMINI_PROXY_URL = "/.netlify/functions/synapseGemini";
        const SEARCH_PROXY_URL = "/.netlify/functions/searchStandard";
        const GROUPS_PROXY_URL = "/.netlify/functions/groupIntelligence";

        // Server callers
        async function callGemini(payload){
          const idToken = await firebase.auth().currentUser.getIdToken();
          const res = await fetch(GEMINI_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${idToken}`},
            body: JSON.stringify(payload)
          });
          const txt = await res.text(); if(!res.ok) throw new Error(txt || ('Gemini '+res.status));
          return JSON.parse(txt); // { title, text }
        }
        async function callSearch({subject,grade}){
          const idToken = await firebase.auth().currentUser.getIdToken();
          const res = await fetch(SEARCH_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${idToken}`},
            body: JSON.stringify({subject,grade})
          });
          const txt = await res.text(); if(!res.ok) throw new Error(txt || ('Search '+res.status));
          return JSON.parse(txt); // { standards:[...] }
        }
        async function callGroups({roster,standard,goal='homogeneous'}){
          const idToken = await firebase.auth().currentUser.getIdToken();
          const res = await fetch(GROUPS_PROXY_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${idToken}`},
            body: JSON.stringify({roster,standard,goal})
          });
          const txt = await res.text(); if(!res.ok) throw new Error(txt || ('Groups '+res.status));
          return JSON.parse(txt); // { class_summary, groups }
        }

        // --- Minimal UI so you see something immediately ---
        function App(){
          const [subject,setSubject] = React.useState('Civics');
          const [grade,setGrade]     = React.useState('7');
          const [standards,setStandards] = React.useState([]);
          const [msg,setMsg] = React.useState('Synapse Co-Pilot ready');

          async function fetchStandards(){
            try{
              setMsg('Fetching standards…');
              const res = await callSearch({subject,grade});
              setStandards(res.standards || []);
              setMsg('Loaded ✓');
            }catch(e){ setMsg('Error: '+e.message); }
          }

          return (
            <div className="max-w-3xl mx-auto p-6">
              <h1 className="text-2xl font-bold mb-2">Synapse Co-Pilot</h1>
              <p className="text-sm opacity-80 mb-4">{msg}</p>

              <div className="grid gap-3 sm:grid-cols-3 mb-4">
                <label className="block">
                  <span className="text-xs opacity-80">Subject</span>
                  <input className="mt-1 w-full bg-white/5 border border-white/10 rounded px-2 py-2"
                         value={subject} onChange={e=>setSubject(e.target.value)} />
                </label>
                <label className="block">
                  <span className="text-xs opacity-80">Grade</span>
                  <input className="mt-1 w-full bg-white/5 border border-white/10 rounded px-2 py-2"
                         value={grade} onChange={e=>setGrade(e.target.value)} />
                </label>
                <div className="flex items-end">
                  <button className="w-full min-h-[44px] bg-white text-black rounded px-3 py-2"
                          onClick={fetchStandards}>Fetch Standards</button>
                </div>
              </div>

              <ul className="text-sm space-y-1">
                {standards.length === 0 && <li className="opacity-70">No standards loaded yet.</li>}
                {standards.map(s => <li key={s.code}><span className="font-semibold">{s.code}</span> — {s.title}</li>)}
              </ul>
            </div>
          );
        }

        ReactDOM.createRoot(rootEl).render(<App />);
        const s2 = document.getElementById('synapse-status');
        if (s2) s2.textContent = 'Rendering…';
      }catch(e){
        showErr(e.message || String(e));
      }
    }
  </script>
</body>
</html>
