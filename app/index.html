<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synapse Standards Browser</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Standards — Teacher View</h1>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <label class="block">
        <span class="text-sm font-medium">Subject</span>
        <select id="subject" class="mt-1 w-full border rounded-lg p-2"></select>
      </label>

      <label class="block">
        <span class="text-sm font-medium">Grade</span>
        <select id="grade" class="mt-1 w-full border rounded-lg p-2"></select>
      </label>

      <button id="loadBtn" class="h-10 px-4 rounded-lg bg-blue-600 text-white">Load Standards</button>
    </div>

    <div class="mt-6">
      <label class="block">
        <span class="text-sm font-medium">Search within selection</span>
        <input id="search" type="text" placeholder="e.g., rule of law" class="mt-1 w-full border rounded-lg p-2" />
      </label>
    </div>

    <ul id="standardsList" class="mt-6 divide-y bg-white rounded-xl shadow-sm"></ul>
  </main>

  <script>
    async function fetchJSON(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error("Failed: " + path);
      return r.json();
    }

    async function loadManifest() {
      const m = await fetchJSON("/standards/index.json");
      const subjectSel = document.getElementById("subject");
      subjectSel.innerHTML = m.subjects.map(s => `<option>${s.subject}</option>`).join("");

      subjectSel.onchange = () => {
        const entry = m.subjects.find(x => x.subject === subjectSel.value);
        const gradeSel = document.getElementById("grade");
        gradeSel.innerHTML = (entry?.grades || []).map(g => `<option>${g}</option>`).join("");
      };
      subjectSel.dispatchEvent(new Event("change"));
    }

    async function loadTeacherList() {
      const subject = document.getElementById("subject").value;
      const grade = document.getElementById("grade").value;
      const url = `/.netlify/functions/standardsCatalog?subject=${encodeURIComponent(subject)}&grade=${encodeURIComponent(grade)}&view=teacher`;
      const data = await fetchJSON(url);
      renderList(data.standards || []);
    }

    async function searchTeacher() {
      const q = document.getElementById("search").value.trim();
      if (!q) return loadTeacherList();
      const subject = document.getElementById("subject").value;
      const grade = document.getElementById("grade").value;
      const url = `/.netlify/functions/searchStandard?q=${encodeURIComponent(q)}&subject=${encodeURIComponent(subject)}&grade=${encodeURIComponent(grade)}&view=teacher`;
      const data = await fetchJSON(url);
      renderList(data.standards || []);
    }

    function renderList(items) {
      const ul = document.getElementById("standardsList");
      if (!items.length) {
        ul.innerHTML = `<li class="p-4 text-slate-500">No standards found.</li>`;
        return;
      }
      ul.innerHTML = items.map(s => `
        <li class="p-4 hover:bg-slate-50">
          <span class="font-semibold">${s.code}</span> — <span>${s.name}</span>
        </li>`).join("");
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadManifest();
      document.getElementById("loadBtn").onclick = loadTeacherList;
      document.getElementById("search").oninput = () => {
        // simple debounce
        clearTimeout(window.__deb);
        window.__deb = setTimeout(searchTeacher, 250);
      };
    });
  </script>
</body>
</html>
